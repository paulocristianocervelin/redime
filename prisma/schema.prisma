// Schema do Prisma para o projeto Redime
// Configuração para PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuários
model User {
  id            BigInt    @id @default(autoincrement())
  email         String?   @unique  // Opcional para membros básicos
  name          String
  cpf           String    @unique  // CPF obrigatório
  password      String?   // Opcional para membros sem acesso ao sistema
  role          UserRole  @default(MEMBER)
  emailVerified Boolean   @default(false)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relações
  memberProfile        MemberProfile?
  donations            Donation[]
  registrations        EventRegistration[]
  prayers              PrayerRequest[]
  comments             Comment[]
  leaderOfDepartments  Department[]       @relation("DepartmentLeader")

  @@map("users")
}

enum UserRole {
  ADMIN
  LEADER
  VOLUNTEER
  MEMBER
}

// Perfil de Membro
model MemberProfile {
  id              BigInt                @id @default(autoincrement())
  userId          BigInt                @unique
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone           String?               // Não obrigatório
  address         String                // Obrigatório
  number          String?               // Número do endereço
  complement      String?               // Complemento do endereço
  city            String?
  state           String?
  zipCode         String?
  birthDate       DateTime?
  baptismDate     DateTime?
  membershipDate  DateTime?
  interests       String[]              // Áreas de interesse
  photo           String?
  bio             String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Relação many-to-many com departamentos
  departments MemberDepartment[]

  @@map("member_profiles")
}

// Tabela intermediária para relação many-to-many entre membros e departamentos
model MemberDepartment {
  id              BigInt        @id @default(autoincrement())
  memberProfileId BigInt
  memberProfile   MemberProfile @relation(fields: [memberProfileId], references: [id], onDelete: Cascade)
  departmentId    BigInt
  department      Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  joinedAt        DateTime      @default(now())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([memberProfileId, departmentId])
  @@map("member_departments")
}

// Departamentos/Ministérios
model Department {
  id          BigInt             @id @default(autoincrement())
  name        String
  slug        String             @unique
  description String
  leaderId    BigInt?            // Líder do departamento
  leader      User?              @relation("DepartmentLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  imageUrl    String?
  category    DepartmentCategory
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relação many-to-many com membros
  members MemberDepartment[]

  @@map("departments")
}

enum DepartmentCategory {
  CHILDREN
  YOUTH
  YOUNG_ADULTS
  WOMEN
  MEN
  MUSIC
  PRAYER
  MISSIONS
  OUTREACH
  MEDIA
  ADMINISTRATION
  TECHNOLOGY
  HOSPITALITY
  SECURITY
  OTHER
}

// Mensagens/Sermões
model Message {
  id          BigInt          @id @default(autoincrement())
  title       String
  slug        String          @unique
  description String?
  videoUrl    String?
  audioUrl    String?
  thumbnail   String?
  preacher    String
  scripture   String?
  date        DateTime
  series      String?
  category    MessageCategory
  featured    Boolean         @default(false)
  views       Int             @default(0)
  published   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relações
  comments Comment[]

  @@map("messages")
}

enum MessageCategory {
  SERMON
  TEACHING
  DEVOTIONAL
  TESTIMONY
}

// Eventos
model Event {
  id               BigInt              @id @default(autoincrement())
  title            String
  slug             String              @unique
  description      String
  eventType        EventType
  startDate        DateTime
  endDate          DateTime?
  location         String?
  address          String?
  imageUrl         String?
  registrationOpen Boolean             @default(true)
  capacity         Int?
  price            Float?              @default(0)
  featured         Boolean             @default(false)
  published        Boolean             @default(false)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relações
  registrations EventRegistration[]

  @@map("events")
}

enum EventType {
  SERVICE
  CONFERENCE
  WORKSHOP
  CONCERT
  RETREAT
  COMMUNITY
}

// Inscrições em Eventos
model EventRegistration {
  id          BigInt             @id @default(autoincrement())
  eventId     BigInt
  event       Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId      BigInt
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status      RegistrationStatus @default(PENDING)
  ticketCount Int                @default(1)
  totalPaid   Float              @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@unique([eventId, userId])
  @@map("event_registrations")
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

// Sala de Oração - Pedidos
model PrayerRequest {
  id          BigInt         @id @default(autoincrement())
  userId      BigInt
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String
  category    PrayerCategory
  isAnonymous Boolean        @default(false)
  isPublic    Boolean        @default(true)
  answered    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("prayer_requests")
}

enum PrayerCategory {
  HEALTH
  FAMILY
  FINANCE
  SPIRITUAL
  GUIDANCE
  THANKSGIVING
  OTHER
}

// Cursos Online
model Course {
  id          BigInt             @id @default(autoincrement())
  title       String
  slug        String             @unique
  description String
  instructor  String
  thumbnail   String?
  videoUrl    String?
  duration    Int?               // em minutos
  level       CourseLevel
  category    String
  price       Float              @default(0)
  featured    Boolean            @default(false)
  published   Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relações
  lessons     Lesson[]
  enrollments CourseEnrollment[]

  @@map("courses")
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Lições do Curso
model Lesson {
  id          BigInt   @id @default(autoincrement())
  courseId    BigInt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  description String?
  videoUrl    String
  duration    Int      // em minutos
  order       Int
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("lessons")
}

// Inscrições em Cursos
model CourseEnrollment {
  id        BigInt   @id @default(autoincrement())
  courseId  BigInt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userEmail String
  progress  Int      @default(0)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userEmail])
  @@map("course_enrollments")
}

// Posts do Blog/Notícias
model BlogPost {
  id          BigInt    @id @default(autoincrement())
  title       String
  slug        String    @unique
  excerpt     String?
  content     String
  author      String
  thumbnail   String?
  category    String
  tags        String[]
  featured    Boolean   @default(false)
  published   Boolean   @default(false)
  publishedAt DateTime?
  views       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relações
  comments Comment[]

  @@map("blog_posts")
}

// Comentários (para Mensagens e Blog)
model Comment {
  id         BigInt    @id @default(autoincrement())
  content    String
  userId     BigInt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messageId  BigInt?
  message    Message?  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  blogPostId BigInt?
  blogPost   BlogPost? @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  approved   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("comments")
}

// Doações
model Donation {
  id            BigInt            @id @default(autoincrement())
  userId        BigInt
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Float
  currency      String            @default("BRL")
  type          DonationType
  frequency     DonationFrequency
  status        DonationStatus
  paymentMethod String?
  transactionId String?           @unique
  message       String?
  isAnonymous   Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@map("donations")
}

enum DonationType {
  GENERAL
  MISSIONS
  BUILDING
  SPECIAL_PROJECT
}

enum DonationFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Ministérios (mantido para compatibilidade)
model Ministry {
  id          BigInt           @id @default(autoincrement())
  name        String
  slug        String           @unique
  description String
  leader      String?
  imageUrl    String?
  category    MinistryCategory
  active      Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("ministries")
}

enum MinistryCategory {
  CHILDREN
  YOUTH
  YOUNG_ADULTS
  WOMEN
  MEN
  MUSIC
  PRAYER
  MISSIONS
  OUTREACH
  MEDIA
}

// Membros da Equipe/Líderes
model TeamMember {
  id        BigInt   @id @default(autoincrement())
  name      String
  role      String
  bio       String?
  photo     String?
  email     String?
  phone     String?
  order     Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("team_members")
}

// Configurações do Site
model SiteSettings {
  id          BigInt   @id @default(autoincrement())
  key         String   @unique
  value       String
  type        String   @default("string")
  description String?
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}

// Transmissões ao Vivo
model LiveStream {
  id          BigInt    @id @default(autoincrement())
  title       String
  description String?
  streamUrl   String
  chatEnabled Boolean   @default(true)
  isLive      Boolean   @default(false)
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  viewers     Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("live_streams")
}
